<!DOCTYPE html>
<html>
  <head>
    <title>SMART Container Example</title>
    <link rel='stylesheet' href='styles.css' type='text/css' />
    <script src="jquery.min.js"></script>
    <script src="jschannel.js"></script>
    <script src="smart-api-container.js"></script>
    <script src="jsonld.js"></script>
    <script src="convert.js"></script>
  </head>
  <body>
    <script>
      /* Sample implementations of SMART Connect Host glue methods */
      SMART = new SMART_CONNECT_HOST();

      SMART.get_iframe = function(app_instance, callback) {
        $("iframe").remove(); // clear old iframes
        $("body").append("<iframe src='about:blank;' id='app_iframe_"+app_instance.uuid+"'></iframe>");
        callback($("iframe")[0]);
      };


      SMART.handle_api = function(app_instance, api_call, callback_success, callback_error) {
        // Implementation of the get medications API call which feeds the data from a static file

        function process(data){
          convert({
            from: "application/json",
            to: "application/rdf+xml",
            body: data
            }, function(err, rdf){
            callback_success({
              contentType: "application/rdf+xml",  
              data: rdf
            })
          });
        };

        var fixture = null;
        if (api_call.func.match(/^.*\/demographics$/)) {
          fixture =  "../fixtures/response/demographics.json";
        }
        if (api_call.func.match(/^.*\/medications\/$/)) {
          fixture =  "../fixtures/response/meds.json";
        }
        if (api_call.func.match(/^.*\/vital_sign_sets\/$/)) {
          fixture =  "../fixtures/response/vitals.json";
        }

        if (api_call.method=="GET" && fixture !== null){
          $.ajax({
            type: 'get', 
            url: fixture,
            dataType: 'text'
          }).success(process);
        } else {
          alert("Function " + api_call.func + " not implemented yet.");
        }
      };

      /* Sample context and manifests for our container */

      var sample_context = { 
        record: {
          full_name: 'Anonymous Patient',
          id: '123'
        },
        user: {
          full_name: 'Logged-in User',
          id: 'user12345'
        }
      };

      var bp_centiles_manifest = {
        "name" : "BP Centiles",
        "description" : "Evaluates Pediatric Blood Pressure",
        "id" : "bp-centiles@apps.smartplatforms.org",
        "mode" : "ui",
        "scope" : "record",
        "index" : "http://sample-apps-v06.smartplatforms.org/framework/bp_centiles/index.html",
        "icon" :  "http://sample-apps-v06.smartplatforms.org/framework/bp_centiles/icon.png"
      };

      var med_list_manifest = {
        "name" : "Med List",
        "description" : "Display medications in a table or timeline view",
        "id" : "med-list@apps.smartplatforms.org",
        "mode" : "ui",	
        "scope": "record",
        "icon" : "http://sample-apps-v06.smartplatforms.org/framework/med_list/icon.png",
        "index": "http://sample-apps-v06.smartplatforms.org/framework/med_list/index.html",
      }

      /* Event handler for the UI buttons in our sample container */
      var launch_app = function(manifest) {
        SMART.launch_app(manifest, sample_context);
      };
    </script>
    <div id="app_selector">
      <input type="submit" value="BP Centiles" onclick="launch_app(bp_centiles_manifest)"/>
      <input type="submit" value="Med List" onclick="launch_app(med_list_manifest)"/>
    </div>
  </body>
</html>
